# Tagbase server

## Overview

Tagbase is a [Flask](http://flask.pocoo.org/) application which provides HTTP endpoints for ingestion of 
various files into the Tagbase SQL database. 

This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the
[OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub.  This
is an example of building a swagger-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Requirements
Python 3.5.2+
Postgres (ensure that the both ```log_timezone = 'UTC'``` and ```timezone = 'UTC'``` are set in ```postgresql.conf```

## Usage
To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
python3 -m swagger_server
```

and open your browser to here:

```
http://localhost:5433/v1/tagbase/ui/
```

Your Swagger definition lives here:

```
http://localhost:5433/v1/tagbase/swagger.json
```
To edit the Swagger definition file, navigate to
```
http://editor.swagger.io/#
```
You can then load the swagger definition and hack away!

To launch the integration tests, use tox:
```
sudo pip install tox
tox
```

## Tagbase Postgres DB

The Tagbase server requires access to a (Postgres) SQL DB. We can create this as follows
```
$ brew install postgresql
```
You can then start this in the foreground as follows
```
$ postgres -D /usr/local/var/postgres
```
Postgres data tables still need to be defined however. Simply execute
```
$ psql -f sqldb/tagbase-schema.sql
```
The above creates the original database, tables, sequences and indexes. You should see the following
```
psql:sqldb/tagbase-schema.sql:1: ERROR:  role "tagbase" already exists
psql:sqldb/tagbase-schema.sql:3: ERROR:  database "tagbase" already exists
You are now connected to database "tagbase" as user "...".
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
```
The you can go ahead and import initial data into the DB
```
$ psql -f sqldb/metadata_types.sql
```
This will provide the following output
```
You are now connected to database "tagbase" as user "...".
INSERT 0 142
```
You can go ahead and now connect to the DB (using ```psql```) and query data e.g.
```
lmcgibbn=# \connect tagbase
You are now connected to database "tagbase" as user "...".
tagbase=# \dt
                  List of relations
 Schema |          Name           | Type  |  Owner
--------+-------------------------+-------+----------
 public | data_histogram_bin_data | table | lmcgibbn
 public | data_histogram_bin_info | table | lmcgibbn
 public | data_histogram_bin_unit | table | lmcgibbn
 public | data_position           | table | lmcgibbn
 public | data_profile            | table | lmcgibbn
 public | data_time_series        | table | lmcgibbn
 public | metadata                | table | lmcgibbn
 public | metadata_types          | table | lmcgibbn
 public | observation_types       | table | lmcgibbn
 public | proc_observations       | table | lmcgibbn
 public | submission              | table | lmcgibbn
(11 rows)

tagbase=# SELECT * FROM metadata_types ;
...
attribute_id |      category       |         attribute_name          |  type  |                                                                 description                                                                  |                                                                                                                                       example                                                                                                                                        |                                                                                                                                                                   comments                                                                                                                                                                    |  necessity
--------------+---------------------+---------------------------------+--------+----------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------
            1 | instrument          | instrument_name                 | string | Append an identifer that is unique within your organization. This is essential if a device is recycled.                                      | 16P0100-Refurb2

```
You are now ready to begin interacting with the Tagbase server via the REST endpoints. You can do this by navigating to your Browser at http://localhost:5433/v1/tagbase/ui/ and interacting with the various endpoints.

## Running with Docker

To run the server on a Docker container, please execute the following from the root directory:

```bash
# building the image
docker build -t swagger_server .

# starting up a container
docker run -p 5433:5433 swagger_server
```

## Development, Support and Community
Please reach out to the OIIP project team at <oiip@jpl.nasa.gov>